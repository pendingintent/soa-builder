<div class="modal-overlay" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.55);display:flex;align-items:center;justify-content:center;z-index:500;">
  <div class="modal" style="background:#fff;max-width:820px;width:92%;max-height:80%;overflow:auto;padding:14px 18px;border-radius:6px;box-shadow:0 4px 18px rgba(0,0,0,0.3);font-size:0.75em;line-height:1.3;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;gap:8px;flex-wrap:wrap;">
      <h4 style="margin:0;">Reorder Audit Log</h4>
      <button onclick="this.closest('.modal-overlay').remove()" style="background:#c62828;color:#fff;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:0.7em;">Close</button>
    </div>
    <div style="font-size:0.65em;color:#555;margin-bottom:6px;">Tracks manual drag & drop ordering changes for visits and activities. Old/New columns show ID sequences (left to right order_index ascending).</div>
    {% if audit %}
      <table style="width:100%;border-collapse:collapse;font-size:0.7em;">
        <thead>
          <tr style="background:#eceff1;">
            <th style="text-align:left;padding:4px;border-bottom:1px solid #b0bec5;">ID</th>
            <th style="text-align:left;padding:4px;border-bottom:1px solid #b0bec5;">Entity</th>
            <th style="text-align:left;padding:4px;border-bottom:1px solid #b0bec5;">Performed At (UTC)</th>
            <th style="text-align:left;padding:4px;border-bottom:1px solid #b0bec5;white-space:nowrap;">Old Order</th>
            <th style="text-align:left;padding:4px;border-bottom:1px solid #b0bec5;white-space:nowrap;">New Order</th>
            <th style="text-align:left;padding:4px;border-bottom:1px solid #b0bec5;">Changes</th>
          </tr>
        </thead>
        <tbody>
          {% for r in audit %}
            {% set old_map = {} %}
            {% for oid in r.old_order %}{% set _ = old_map.update({oid: loop.index}) %}{% endfor %}
            <tr>
              <td style="padding:3px;border-bottom:1px solid #eee;">{{ r.id }}</td>
              <td style="padding:3px;border-bottom:1px solid #eee;">{{ r.entity_type }}</td>
              <td style="padding:3px;border-bottom:1px solid #eee;white-space:nowrap;">{{ r.performed_at }}</td>
              <td style="padding:3px;border-bottom:1px solid #eee;font-family:monospace;">{{ r.old_order|join(',') }}</td>
              <td style="padding:3px;border-bottom:1px solid #eee;font-family:monospace;">{{ r.new_order|join(',') }}</td>
              <td style="padding:3px;border-bottom:1px solid #eee;">
                {% set moved = [] %}
                {% for nid in r.new_order %}
                  {% set old_pos = old_map.get(nid) %}
                  {% if old_pos and old_pos != loop.index %}
                    {% set _ = moved.append(nid ~ ':' ~ old_pos ~ '→' ~ loop.index) %}
                  {% endif %}
                {% endfor %}
                {% if moved %}
                  <span title="Format: ID:oldPos→newPos">{{ moved|join('; ') }}</span>
                {% else %}
                  <span style="color:#777;">reindexed only</span>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <div style="font-size:0.65em;color:#777;">No reorder operations recorded yet.</div>
    {% endif %}
  </div>
</div>
